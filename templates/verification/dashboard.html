{% extends 'verification/base.html' %}

{% block title %}Property Export Verification Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-md-12">
      <h1>Property Export Verification Dashboard</h1>
      <p class="lead">Monitor and test the SQL Server connection and property export functionality.</p>
    </div>
  </div>

  <!-- System Status Cards -->
  <div class="row">
    <div class="col-md-3">
      <div class="card status-card {% if sql_server_status == 'Verified' %}status-success{% elif sql_server_status == 'Not Configured' %}status-danger{% else %}status-warning{% endif %}">
        <div class="card-header">SQL Server Connection</div>
        <div class="card-body">
          <h5 class="card-title">{{ sql_server_status }}</h5>
          <p class="card-text">{{ connection_details.message if connection_details else 'Connection status not verified' }}</p>
          <button class="btn btn-sm btn-primary" id="test-connection-btn">Test Connection</button>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card status-card {% if stored_procedure_status == 'Verified' %}status-success{% elif stored_procedure_status == 'Not Found' %}status-danger{% else %}status-warning{% endif %}">
        <div class="card-header">Stored Procedure</div>
        <div class="card-body">
          <h5 class="card-title">{{ stored_procedure_status }}</h5>
          <p class="card-text">{{ stored_procedure_details.message if stored_procedure_details else 'Stored procedure not verified' }}</p>
          <button class="btn btn-sm btn-primary" id="test-sp-btn">Test Procedure</button>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card status-card {% if api_status == 'All Available' %}status-success{% elif api_status == 'Not Configured' %}status-danger{% else %}status-warning{% endif %}">
        <div class="card-header">API Endpoints</div>
        <div class="card-body">
          <h5 class="card-title">{{ api_status }}</h5>
          <p class="card-text">{{ api_details.message if api_details else 'API endpoints not verified' }}</p>
          <button class="btn btn-sm btn-primary" id="test-api-btn">Test Endpoints</button>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card status-card {% if overall_status == 'Ready' %}status-success{% elif overall_status == 'Not Ready' %}status-danger{% else %}status-warning{% endif %}">
        <div class="card-header">Overall Status</div>
        <div class="card-body">
          <h5 class="card-title">{{ overall_status }}</h5>
          <p class="card-text">{{ overall_message }}</p>
          <button class="btn btn-sm btn-primary" id="run-all-tests-btn">Run All Tests</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Verification Actions -->
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          Advanced Verification Tests
        </div>
        <div class="card-body verification-actions">
          <div class="btn-group" role="group">
            <button class="btn btn-outline-primary test-btn" id="test-pacs-oltp-btn">Test pacs_oltp Connection</button>
            <button class="btn btn-outline-primary test-btn" id="test-pacs-training-btn">Test pacs_training Connection</button>
            <button class="btn btn-outline-primary test-btn" id="test-web-internet-benton-btn">Test web_internet_benton Connection</button>
            <button class="btn btn-outline-primary test-btn" id="test-property-access-btn">Test PropertyAccess Export</button>
            <button class="btn btn-outline-primary test-btn" id="test-performance-btn">Test Performance (1000 records)</button>
            <button class="btn btn-outline-primary test-btn" id="test-schema-comparison-btn">Compare Database Schemas</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Verification Results -->
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          Verification Results
          <button class="btn btn-sm btn-outline-secondary float-right" id="clear-results-btn">Clear Results</button>
        </div>
        <div class="card-body">
          <div class="test-results" id="test-results">
            {% if last_test_results %}
              {% for result in last_test_results %}
                <div class="result-item {% if result.success %}result-success{% else %}result-error{% endif %}">
                  <h5>{{ result.test_name }}</h5>
                  <p><strong>Status:</strong> {% if result.success %}Success{% else %}Failed{% endif %}</p>
                  <p><strong>Message:</strong> {{ result.message }}</p>
                  {% if result.details %}
                    <p><strong>Details:</strong></p>
                    <pre><code>{{ result.details|tojson(indent=2) }}</code></pre>
                  {% endif %}
                  <p class="text-muted">{{ result.timestamp }}</p>
                </div>
              {% endfor %}
            {% else %}
              <div class="alert alert-info">No verification tests have been run yet.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Logs -->
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          Recent Logs
        </div>
        <div class="card-body">
          <div class="log-entries" id="log-entries">
            {% if sync_logs %}
              {% for log in sync_logs %}
                <div class="log-entry log-{{ log.level }}">
                  <strong>{{ log.timestamp }}</strong> [{{ log.level }}] {{ log.component }}: {{ log.message }}
                </div>
              {% endfor %}
            {% else %}
              <div class="alert alert-info">No logs available.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Jobs -->
  <div class="row mt-4 mb-5">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          Recent Verification Jobs
        </div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Job ID</th>
                <th>Name</th>
                <th>Status</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Duration</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if recent_jobs %}
                {% for job in recent_jobs %}
                  <tr>
                    <td>{{ job.job_id[:8] }}</td>
                    <td>{{ job.name }}</td>
                    <td>
                      <span class="badge 
                        {% if job.status == 'completed' %}badge-success
                        {% elif job.status == 'failed' %}badge-danger
                        {% elif job.status == 'running' %}badge-primary
                        {% elif job.status == 'testing' %}badge-info
                        {% else %}badge-secondary{% endif %}">
                        {{ job.status }}
                      </span>
                    </td>
                    <td>{{ job.start_time.strftime('%Y-%m-%d %H:%M:%S') if job.start_time else 'N/A' }}</td>
                    <td>{{ job.end_time.strftime('%Y-%m-%d %H:%M:%S') if job.end_time else 'N/A' }}</td>
                    <td>
                      {% if job.start_time and job.end_time %}
                        {{ (job.end_time - job.start_time).total_seconds()|round(2) }}s
                      {% else %}
                        N/A
                      {% endif %}
                    </td>
                    <td>
                      <a href="{{ url_for('sync.job_details', job_id=job.job_id) }}" class="btn btn-sm btn-outline-info">Details</a>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="7" class="text-center">No verification jobs found</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="test-results-modal" tabindex="-1" role="dialog" aria-labelledby="testResultsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="testResultsModalLabel">Test Results</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="modal-results-content">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
  // Test Connection
  $('#test-connection-btn').click(function() {
    runTest('/verification/api/test-connection', 'Testing SQL Server Connection');
  });
  
  // Test Stored Procedure
  $('#test-sp-btn').click(function() {
    runTest('/verification/api/test-stored-procedure', 'Testing ExportPropertyAccess Stored Procedure');
  });
  
  // Test API Endpoints
  $('#test-api-btn').click(function() {
    runTest('/verification/api/test-api-endpoints', 'Testing API Endpoints');
  });
  
  // Run All Tests
  $('#run-all-tests-btn').click(function() {
    runTest('/verification/api/run-all-tests', 'Running All Verification Tests');
  });
  
  // Advanced Tests
  $('#test-pacs-oltp-btn').click(function() {
    runTest('/verification/api/test-database-connection?database=pacs_oltp', 'Testing pacs_oltp Connection');
  });
  
  $('#test-pacs-training-btn').click(function() {
    runTest('/verification/api/test-database-connection?database=pacs_training', 'Testing pacs_training Connection');
  });
  
  $('#test-web-internet-benton-btn').click(function() {
    runTest('/verification/api/test-database-connection?database=web_internet_benton', 'Testing web_internet_benton Connection');
  });
  
  $('#test-property-access-btn').click(function() {
    runTest('/verification/api/test-property-access', 'Testing PropertyAccess Export');
  });
  
  $('#test-performance-btn').click(function() {
    runTest('/verification/api/test-performance', 'Testing Export Performance');
  });
  
  $('#test-schema-comparison-btn').click(function() {
    runTest('/verification/api/compare-schemas', 'Comparing Database Schemas');
  });
  
  // Clear Results
  $('#clear-results-btn').click(function() {
    $('#test-results').html('<div class="alert alert-info">Results cleared</div>');
  });
  
  // Function to run a test and display results
  function runTest(url, title) {
    $('#modal-results-content').html('<div class="text-center"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div><p class="mt-2">Running test...</p></div>');
    $('#testResultsModalLabel').text(title);
    $('#test-results-modal').modal('show');
    
    $.ajax({
      url: url,
      type: 'GET',
      dataType: 'json',
      success: function(response) {
        let html = '';
        if (response.success) {
          html += '<div class="alert alert-success"><strong>Success!</strong> ' + response.message + '</div>';
        } else {
          html += '<div class="alert alert-danger"><strong>Error!</strong> ' + response.message + '</div>';
        }
        
        if (response.details) {
          html += '<h5>Details:</h5>';
          html += '<pre><code>' + JSON.stringify(response.details, null, 2) + '</code></pre>';
        }
        
        $('#modal-results-content').html(html);
        
        // Also add to the results section on the page
        let resultItem = '<div class="result-item ' + (response.success ? 'result-success' : 'result-error') + '">';
        resultItem += '<h5>' + title + '</h5>';
        resultItem += '<p><strong>Status:</strong> ' + (response.success ? 'Success' : 'Failed') + '</p>';
        resultItem += '<p><strong>Message:</strong> ' + response.message + '</p>';
        
        if (response.details) {
          resultItem += '<p><strong>Details:</strong></p>';
          resultItem += '<pre><code>' + JSON.stringify(response.details, null, 2) + '</code></pre>';
        }
        
        resultItem += '<p class="text-muted">' + new Date().toLocaleString() + '</p>';
        resultItem += '</div>';
        
        $('#test-results').prepend(resultItem);
      },
      error: function() {
        $('#modal-results-content').html('<div class="alert alert-danger">An error occurred while running the test.</div>');
      }
    });
  }
});
</script>
{% endblock %}