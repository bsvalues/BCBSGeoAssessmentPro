{% extends "base.html" %}

{% block title %}User Management{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row">
    <div class="col-12">
      <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h2 class="mb-0">User Management</h2>
          <a href="{{ url_for('auth.initialize_roles_route') }}" class="btn btn-light btn-sm">
            <i class="bi bi-gear"></i> Initialize Roles
          </a>
        </div>
        <div class="card-body">
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
              {% endfor %}
            {% endif %}
          {% endwith %}
          
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Name</th>
                  <th>Department</th>
                  <th>Roles</th>
                  <th>Last Login</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr>
                  <td>{{ user.email }}</td>
                  <td>{{ user.full_name or 'Not set' }}</td>
                  <td>{{ user.department or 'Not set' }}</td>
                  <td>
                    <div class="role-badges">
                      {% if user.roles %}
                        {% for role in user.roles %}
                          <span class="badge bg-primary">{{ role }}</span>
                        {% endfor %}
                      {% else %}
                        <span class="badge bg-secondary">No roles</span>
                      {% endif %}
                    </div>
                  </td>
                  <td>{{ user.last_sign_in_at|datetime if user.last_sign_in_at else 'Never' }}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary edit-roles-btn" data-bs-toggle="modal" data-bs-target="#editRolesModal" data-user-id="{{ user.id }}" data-user-email="{{ user.email }}" data-user-roles="{{ user.roles|join(',') }}">
                      <i class="bi bi-pencil"></i> Edit Roles
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          {% if total_pages > 1 %}
          <div class="d-flex justify-content-center mt-4">
            <nav aria-label="Page navigation">
              <ul class="pagination">
                {% if page > 1 %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('auth.user_list', page=page-1) }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                {% endif %}
                
                {% for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                  <a class="page-link" href="{{ url_for('auth.user_list', page=p) }}">{{ p }}</a>
                </li>
                {% endfor %}
                
                {% if page < total_pages %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('auth.user_list', page=page+1) }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Roles Modal -->
<div class="modal fade" id="editRolesModal" tabindex="-1" aria-labelledby="editRolesModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="editRolesModalLabel">Edit User Roles</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editRolesForm">
          <input type="hidden" id="userId" name="userId">
          
          <p>Editing roles for: <strong id="userEmail"></strong></p>
          
          <div class="mb-3">
            <label class="form-label">Assigned Roles:</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="admin" id="role_admin">
              <label class="form-check-label" for="role_admin">
                Admin
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="data_setup" id="role_data_setup">
              <label class="form-check-label" for="role_data_setup">
                Data Setup
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="mobile_assessor" id="role_mobile_assessor">
              <label class="form-check-label" for="role_mobile_assessor">
                Mobile Assessor
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="analyst" id="role_analyst">
              <label class="form-check-label" for="role_analyst">
                Analyst
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="viewer" id="role_viewer">
              <label class="form-check-label" for="role_viewer">
                Viewer
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveRolesBtn">Save Changes</button>
      </div>
    </div>
  </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Setup modal form when edit roles button is clicked
  const editButtons = document.querySelectorAll('.edit-roles-btn');
  editButtons.forEach(button => {
    button.addEventListener('click', function() {
      const userId = this.getAttribute('data-user-id');
      const userEmail = this.getAttribute('data-user-email');
      const userRoles = this.getAttribute('data-user-roles').split(',');
      
      // Reset form
      document.querySelectorAll('#editRolesForm input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // Set user ID and email
      document.getElementById('userId').value = userId;
      document.getElementById('userEmail').textContent = userEmail;
      
      // Check the roles this user has
      userRoles.forEach(role => {
        if (role) {
          const checkbox = document.getElementById(`role_${role}`);
          if (checkbox) {
            checkbox.checked = true;
          }
        }
      });
    });
  });
  
  // Handle save button click
  document.getElementById('saveRolesBtn').addEventListener('click', function() {
    const userId = document.getElementById('userId').value;
    const checkboxes = document.querySelectorAll('#editRolesForm input[type="checkbox"]:checked');
    const roles = Array.from(checkboxes).map(checkbox => checkbox.value);
    
    // Send AJAX request to update roles
    fetch(`/auth/api/users/${userId}/roles`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        roles: roles
      }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Close modal and reload page to see updates
        const modal = bootstrap.Modal.getInstance(document.getElementById('editRolesModal'));
        modal.hide();
        window.location.reload();
      } else {
        alert('Error updating roles: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while updating roles');
    });
  });
});
</script>
{% endblock %}
{% endblock %}