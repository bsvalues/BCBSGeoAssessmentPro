{% extends "base.html" %}

{% block title %}Property Assessments{% endblock %}

{% block styles %}
<style>
    .assessment-card {
        transition: transform 0.2s;
    }
    
    .assessment-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .status-badge {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    
    .assessment-chart {
        height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">Property Assessments</h1>
            <p class="text-muted mb-0">{{ property.address or 'Property' }} | Parcel ID: {{ property.parcel_id }}</p>
        </div>
        
        <div class="d-flex">
            <a href="{{ url_for('property.property_detail', property_id=property.id) }}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left"></i> Back to Property
            </a>
            
            {% if has_role('admin') or has_role('editor') %}
            <a href="{{ url_for('property.assessment_create', property_id=property.id) }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Add Assessment
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Assessment History</h5>
                </div>
                <div class="card-body">
                    {% if assessments %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Tax Year</th>
                                        <th>Assessment Date</th>
                                        <th>Land Value</th>
                                        <th>Improvement Value</th>
                                        <th>Total Value</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for assessment in assessments|sort(attribute='tax_year', reverse=True) %}
                                        <tr>
                                            <td>{{ assessment.tax_year }}</td>
                                            <td>{{ assessment.assessment_date|dateformat if assessment.assessment_date else 'N/A' }}</td>
                                            <td>${{ assessment.land_value|default(0)|round(2)|commaformat }}</td>
                                            <td>${{ assessment.improvement_value|default(0)|round(2)|commaformat }}</td>
                                            <td>${{ assessment.total_value|default(0)|round(2)|commaformat }}</td>
                                            <td>
                                                {% if assessment.assessment_status == 'approved' %}
                                                <span class="badge bg-success">Approved</span>
                                                {% elif assessment.assessment_status == 'pending' %}
                                                <span class="badge bg-warning">Pending</span>
                                                {% elif assessment.assessment_status == 'rejected' %}
                                                <span class="badge bg-danger">Rejected</span>
                                                {% else %}
                                                <span class="badge bg-secondary">{{ assessment.assessment_status|capitalize }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    {% if has_role('admin') or has_role('editor') %}
                                                    <a href="{{ url_for('property.assessment_edit', property_id=property.id, assessment_id=assessment.id) }}" class="btn btn-outline-primary">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteAssessmentModal" data-assessment-id="{{ assessment.id }}" data-assessment-year="{{ assessment.tax_year }}">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                    {% else %}
                                                    <a href="javascript:void(0)" class="btn btn-outline-secondary disabled">
                                                        <i class="bi bi-eye"></i> View Only
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            No assessments have been recorded for this property yet.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Property Value Trend</h5>
                </div>
                <div class="card-body">
                    {% if assessments %}
                        <canvas id="valueTrendChart" class="assessment-chart"></canvas>
                    {% else %}
                        <div class="alert alert-info">
                            No assessment data available to display trends.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Current Year Summary</h5>
                </div>
                <div class="card-body">
                    {% set current_year = now().year %}
                    {% set current_assessment = none %}
                    {% for assessment in assessments %}
                        {% if assessment.tax_year == current_year %}
                            {% set current_assessment = assessment %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if current_assessment %}
                        <div class="mb-3">
                            <span class="badge 
                                {% if current_assessment.assessment_status == 'approved' %}bg-success
                                {% elif current_assessment.assessment_status == 'pending' %}bg-warning
                                {% elif current_assessment.assessment_status == 'rejected' %}bg-danger
                                {% else %}bg-secondary{% endif %} mb-2">
                                {{ current_assessment.assessment_status|capitalize }}
                            </span>
                            <h4 class="mb-0">${{ current_assessment.total_value|default(0)|round(2)|commaformat }}</h4>
                            <p class="text-muted">Total Assessed Value</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <h5 class="mb-0">${{ current_assessment.land_value|default(0)|round(2)|commaformat }}</h5>
                                    <p class="text-muted">Land Value</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <h5 class="mb-0">${{ current_assessment.improvement_value|default(0)|round(2)|commaformat }}</h5>
                                    <p class="text-muted">Improvement Value</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <h5 class="mb-0">${{ current_assessment.exemption_value|default(0)|round(2)|commaformat }}</h5>
                                    <p class="text-muted">Exemptions</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <h5 class="mb-0">${{ current_assessment.taxable_value|default(0)|round(2)|commaformat }}</h5>
                                    <p class="text-muted">Taxable Value</p>
                                </div>
                            </div>
                        </div>
                        
                        {% if current_assessment.notes %}
                        <div class="mt-3">
                            <h6>Notes:</h6>
                            <p class="mb-0">{{ current_assessment.notes }}</p>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">
                            No assessment for the current tax year ({{ current_year }}).
                        </div>
                        
                        {% if has_role('admin') or has_role('editor') %}
                        <div class="d-grid">
                            <a href="{{ url_for('property.assessment_create', property_id=property.id) }}" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Add {{ current_year }} Assessment
                            </a>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Assessment Modal -->
{% if has_role('admin') or has_role('editor') %}
<div class="modal fade" id="deleteAssessmentModal" tabindex="-1" aria-labelledby="deleteAssessmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteAssessmentModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this assessment? This action cannot be undone.</p>
                <p><strong>Tax Year:</strong> <span id="deleteTaxYear"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteAssessmentForm" method="POST" action="">
                    <button type="submit" class="btn btn-danger">Delete Assessment</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if assessments %}
        // Extract assessment data for the chart
        const assessmentData = {{ assessments|tojson }};
        
        // Sort by tax year
        assessmentData.sort((a, b) => a.tax_year - b.tax_year);
        
        // Extract years and values
        const years = assessmentData.map(assessment => assessment.tax_year);
        const landValues = assessmentData.map(assessment => assessment.land_value || 0);
        const improvementValues = assessmentData.map(assessment => assessment.improvement_value || 0);
        const totalValues = assessmentData.map(assessment => assessment.total_value || 0);
        
        // Create the chart
        const ctx = document.getElementById('valueTrendChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: years,
                datasets: [
                    {
                        label: 'Total Value',
                        data: totalValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    },
                    {
                        label: 'Land Value',
                        data: landValues,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    },
                    {
                        label: 'Improvement Value',
                        data: improvementValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += '$' + context.parsed.y.toLocaleString();
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
        {% endif %}
        
        // Handle delete modal
        const deleteModal = document.getElementById('deleteAssessmentModal');
        if (deleteModal) {
            deleteModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const assessmentId = button.getAttribute('data-assessment-id');
                const taxYear = button.getAttribute('data-assessment-year');
                
                document.getElementById('deleteTaxYear').textContent = taxYear;
                document.getElementById('deleteAssessmentForm').action = `{{ url_for('property.property_assessments', property_id=property.id) }}`.replace('assessments', `assessments/${assessmentId}/delete`);
            });
        }
    });
</script>
{% endblock %}