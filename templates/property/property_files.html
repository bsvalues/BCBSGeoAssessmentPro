{% extends "layout.html" %}

{% block title %}Property Files - {{ property.parcel_id }} - GeoAssessmentPro{% endblock %}

{% block additionalcss %}
<style>
    .files-header {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .file-card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: transform 0.3s ease;
    }
    
    .file-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .file-icon {
        font-size: 2rem;
        margin-bottom: 10px;
    }
    
    .file-icon.image {
        color: #20c997;
    }
    
    .file-icon.document {
        color: #0d6efd;
    }
    
    .file-icon.pdf {
        color: #dc3545;
    }
    
    .file-icon.spreadsheet {
        color: #198754;
    }
    
    .file-icon.archive {
        color: #fd7e14;
    }
    
    .file-icon.other {
        color: #6c757d;
    }
    
    .file-metadata {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .drop-zone {
        border: 2px dashed #ced4da;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s ease;
    }
    
    .drop-zone:hover, .drop-zone.dragover {
        border-color: #0d6efd;
    }
    
    .drop-zone-icon {
        font-size: 3rem;
        color: #6c757d;
        margin-bottom: 10px;
    }
    
    .drop-zone-text {
        color: #6c757d;
    }
    
    .file-action {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    
    .category-badge {
        position: absolute;
        top: 10px;
        left: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('property.property_list') }}">Properties</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('property.property_detail', property_id=property.id) }}">{{ property.parcel_id }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Files</li>
        </ol>
    </nav>
    
    <!-- Files Header -->
    <div class="files-header">
        <div class="row">
            <div class="col-md-8">
                <h1 class="h2">
                    <i class="fas fa-file me-2"></i> Property Files
                </h1>
                <h2 class="h4 text-muted">
                    Parcel ID: {{ property.parcel_id }}
                    {% if property.account_number %}
                    <span class="ms-3 small text-muted">Account #: {{ property.account_number }}</span>
                    {% endif %}
                </h2>
                <p class="lead">
                    {{ property.address }}, {{ property.city }}, {{ property.state }} {{ property.zip_code }}
                </p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <a href="{{ url_for('property.property_detail', property_id=property.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Back to Property
                </a>
            </div>
        </div>
    </div>
    
    <!-- File Upload Section -->
    {% if has_permission('property.file.upload') %}
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h2 class="h5 mb-0">
                <i class="fas fa-upload me-2"></i> Upload Files
            </h2>
        </div>
        <div class="card-body">
            <form method="post" action="{{ url_for('property.property_file_upload', property_id=property.id) }}" enctype="multipart/form-data" id="upload-form" class="needs-validation" novalidate>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="drop-zone" id="drop-zone">
                            <div class="drop-zone-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="drop-zone-text">
                                <p class="mb-1">Drop files here or click to upload</p>
                                <p class="small text-muted">Supported formats: PDF, JPG, PNG, DOC, DOCX, XLS, XLSX, ZIP</p>
                            </div>
                            <input type="file" name="file" id="file-upload" class="d-none" required>
                        </div>
                        <div class="invalid-feedback">
                            Please select a file to upload.
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="file-name" class="form-label">File Display Name</label>
                            <input type="text" class="form-control" id="file-name" name="file_name" placeholder="Enter a display name for the file">
                            <div class="form-text">Optional. If left blank, the original filename will be used.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="file-category" class="form-label">File Category</label>
                            <select class="form-select" id="file-category" name="file_category">
                                <option value="photo">Photo</option>
                                <option value="assessment">Assessment Document</option>
                                <option value="deed">Deed/Title</option>
                                <option value="survey">Survey</option>
                                <option value="tax">Tax Document</option>
                                <option value="permit">Permit</option>
                                <option value="inspection">Inspection Report</option>
                                <option value="other" selected>Other</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="file-description" class="form-label">Description</label>
                            <textarea class="form-control" id="file-description" name="description" rows="2" placeholder="Enter a description for this file"></textarea>
                        </div>
                        
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary" id="upload-button" disabled>
                                <i class="fas fa-upload me-1"></i> Upload File
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3" id="file-preview-container" style="display: none;">
                    <hr>
                    <h3 class="h6 mb-3">File Preview</h3>
                    <div class="row">
                        <div class="col-md-2 text-center" id="file-icon-preview">
                            <i class="fas fa-file fa-3x text-primary"></i>
                        </div>
                        <div class="col-md-10">
                            <p class="mb-1" id="file-name-preview">filename.ext</p>
                            <p class="small text-muted mb-1" id="file-size-preview">File size: 0 KB</p>
                            <p class="small text-muted" id="file-type-preview">File type: Unknown</p>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    
    <!-- File Category Filter -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h2 class="h5 mb-0">
                <i class="fas fa-filter me-2"></i> Filter Files
            </h2>
        </div>
        <div class="card-body">
            <div class="btn-group w-100" role="group" aria-label="File category filter">
                <input type="radio" class="btn-check" name="category-filter" id="all-files" value="all" autocomplete="off" checked>
                <label class="btn btn-outline-primary" for="all-files">All Files</label>
                
                <input type="radio" class="btn-check" name="category-filter" id="photos" value="photo" autocomplete="off">
                <label class="btn btn-outline-primary" for="photos">Photos</label>
                
                <input type="radio" class="btn-check" name="category-filter" id="assessment-docs" value="assessment" autocomplete="off">
                <label class="btn btn-outline-primary" for="assessment-docs">Assessment</label>
                
                <input type="radio" class="btn-check" name="category-filter" id="deeds" value="deed" autocomplete="off">
                <label class="btn btn-outline-primary" for="deeds">Deeds/Titles</label>
                
                <input type="radio" class="btn-check" name="category-filter" id="surveys" value="survey" autocomplete="off">
                <label class="btn btn-outline-primary" for="surveys">Surveys</label>
                
                <input type="radio" class="btn-check" name="category-filter" id="tax-docs" value="tax" autocomplete="off">
                <label class="btn btn-outline-primary" for="tax-docs">Tax</label>
                
                <input type="radio" class="btn-check" name="category-filter" id="other-docs" value="other" autocomplete="off">
                <label class="btn btn-outline-primary" for="other-docs">Other</label>
            </div>
        </div>
    </div>
    
    <!-- Files List -->
    <div class="mb-5">
        <h2 class="h4 mb-3">
            <i class="fas fa-paperclip me-2"></i> Property Files
            <span class="badge bg-primary ms-2" id="file-count">{{ files|length }}</span>
        </h2>
        
        <!-- No Files Placeholder -->
        {% if not files or files|length == 0 %}
        <div class="text-center py-5 border rounded bg-light" id="no-files-container">
            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
            <h4>No Files Found</h4>
            <p class="text-muted">This property does not have any files yet.</p>
            {% if has_permission('property.file.upload') %}
            <button type="button" class="btn btn-primary mt-2" onclick="document.getElementById('file-upload').click()">
                <i class="fas fa-upload me-1"></i> Upload First File
            </button>
            {% endif %}
        </div>
        
        <!-- Empty Category Result Placeholder (initially hidden) -->
        <div class="text-center py-5 border rounded bg-light d-none" id="no-filter-results">
            <i class="fas fa-filter fa-3x text-muted mb-3"></i>
            <h4>No Files in This Category</h4>
            <p class="text-muted">No files match the selected category filter.</p>
            <button type="button" class="btn btn-outline-primary mt-2" onclick="document.getElementById('all-files').click()">
                <i class="fas fa-list me-1"></i> Show All Files
            </button>
        </div>
        {% else %}
        
        <!-- Files Grid -->
        <div class="row" id="files-container">
            {% for file in files %}
            <div class="col-md-6 col-lg-4 mb-4 file-item" data-category="{{ file.file_category }}">
                <div class="card h-100 file-card">
                    <!-- File Category Badge -->
                    <span class="badge {% if file.file_category == 'photo' %}bg-success{% elif file.file_category == 'assessment' %}bg-primary{% elif file.file_category == 'deed' %}bg-danger{% elif file.file_category == 'survey' %}bg-info{% elif file.file_category == 'tax' %}bg-warning text-dark{% elif file.file_category == 'permit' %}bg-secondary{% elif file.file_category == 'inspection' %}bg-dark{% else %}bg-light text-dark{% endif %} category-badge">
                        {{ file.file_category|title }}
                    </span>
                    
                    <!-- Delete Button -->
                    {% if has_permission('property.file.delete') %}
                    <div class="file-action">
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                data-bs-toggle="modal" 
                                data-bs-target="#deleteModal" 
                                data-file-id="{{ file.id }}"
                                data-file-name="{{ file.file_name }}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    {% endif %}
                    
                    <div class="card-body text-center pt-5">
                        <!-- File Icon -->
                        <div class="file-icon 
                            {% if file.file_type and file.file_type.startswith('image/') %}image
                            {% elif file.file_type == 'application/pdf' %}pdf
                            {% elif file.file_type and (file.file_type.startswith('application/vnd.ms-excel') or file.file_type.startswith('application/vnd.openxmlformats-officedocument.spreadsheet')) %}spreadsheet
                            {% elif file.file_type and (file.file_type.startswith('application/msword') or file.file_type.startswith('application/vnd.openxmlformats-officedocument.word')) %}document
                            {% elif file.file_type and (file.file_type == 'application/zip' or file.file_type == 'application/x-zip-compressed') %}archive
                            {% else %}other{% endif %}">
                            
                            <i class="fas 
                               {% if file.file_type and file.file_type.startswith('image/') %}fa-file-image
                               {% elif file.file_type == 'application/pdf' %}fa-file-pdf
                               {% elif file.file_type and (file.file_type.startswith('application/vnd.ms-excel') or file.file_type.startswith('application/vnd.openxmlformats-officedocument.spreadsheet')) %}fa-file-excel
                               {% elif file.file_type and (file.file_type.startswith('application/msword') or file.file_type.startswith('application/vnd.openxmlformats-officedocument.word')) %}fa-file-word
                               {% elif file.file_type and (file.file_type == 'application/zip' or file.file_type == 'application/x-zip-compressed') %}fa-file-archive
                               {% else %}fa-file{% endif %}">
                            </i>
                        </div>
                        
                        <!-- File Name -->
                        <h3 class="h5 mt-2">{{ file.file_name }}</h3>
                        
                        <!-- File Description (if any) -->
                        {% if file.description %}
                        <p class="mb-3">{{ file.description }}</p>
                        {% endif %}
                        
                        <!-- File Metadata -->
                        <div class="file-metadata mb-3">
                            <p class="mb-1">
                                <i class="fas fa-weight me-1"></i> 
                                {{ file.file_size|filesizeformat if file.file_size else 'Unknown size' }}
                            </p>
                            <p class="mb-1">
                                <i class="fas fa-calendar-alt me-1"></i> 
                                {{ file.created_at|dateformat }}
                            </p>
                        </div>
                        
                        <!-- Download Button -->
                        <a href="{{ file.public_url }}" class="btn btn-outline-primary" target="_blank" download>
                            <i class="fas fa-download me-1"></i> Download
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Delete File Modal -->
{% if has_permission('property.file.delete') %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i> Delete File
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the file <span id="deleteFileName"></span>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-circle me-2"></i> This action cannot be undone. The file will be permanently deleted.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <form id="deleteForm" method="post" action="">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-1"></i> Delete File
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // File upload preview
        const fileUpload = document.getElementById('file-upload');
        const uploadButton = document.getElementById('upload-button');
        const dropZone = document.getElementById('drop-zone');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const fileNamePreview = document.getElementById('file-name-preview');
        const fileSizePreview = document.getElementById('file-size-preview');
        const fileTypePreview = document.getElementById('file-type-preview');
        const fileIconPreview = document.getElementById('file-icon-preview');
        const fileNameInput = document.getElementById('file-name');
        
        if (dropZone) {
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // Highlight drop zone when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            // Handle dropped files
            dropZone.addEventListener('drop', handleDrop, false);
            
            // Handle click to select files
            dropZone.addEventListener('click', function() {
                fileUpload.click();
            });
            
            fileUpload.addEventListener('change', handleFiles);
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function highlight() {
            dropZone.classList.add('dragover');
        }
        
        function unhighlight() {
            dropZone.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileUpload.files = files;
                handleFiles();
            }
        }
        
        function handleFiles() {
            const files = fileUpload.files;
            
            if (files.length > 0) {
                const file = files[0];
                
                // Update file preview
                fileNamePreview.textContent = file.name;
                fileSizePreview.textContent = `File size: ${formatFileSize(file.size)}`;
                fileTypePreview.textContent = `File type: ${file.type || 'Unknown'}`;
                
                // Update file icon
                let iconClass = 'fa-file';
                let iconColor = 'text-secondary';
                
                if (file.type.startsWith('image/')) {
                    iconClass = 'fa-file-image';
                    iconColor = 'text-success';
                } else if (file.type === 'application/pdf') {
                    iconClass = 'fa-file-pdf';
                    iconColor = 'text-danger';
                } else if (file.type.startsWith('application/vnd.ms-excel') || file.type.startsWith('application/vnd.openxmlformats-officedocument.spreadsheet')) {
                    iconClass = 'fa-file-excel';
                    iconColor = 'text-success';
                } else if (file.type.startsWith('application/msword') || file.type.startsWith('application/vnd.openxmlformats-officedocument.word')) {
                    iconClass = 'fa-file-word';
                    iconColor = 'text-primary';
                } else if (file.type === 'application/zip' || file.type === 'application/x-zip-compressed') {
                    iconClass = 'fa-file-archive';
                    iconColor = 'text-warning';
                }
                
                fileIconPreview.innerHTML = `<i class="fas ${iconClass} fa-3x ${iconColor}"></i>`;
                
                // If no filename provided, use the original filename without extension
                if (!fileNameInput.value) {
                    const nameParts = file.name.split('.');
                    if (nameParts.length > 1) {
                        nameParts.pop();
                    }
                    fileNameInput.value = nameParts.join('.');
                }
                
                // Show preview and enable upload button
                filePreviewContainer.style.display = 'block';
                uploadButton.disabled = false;
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Form validation
        const form = document.getElementById('upload-form');
        if (form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                form.classList.add('was-validated');
            });
        }
        
        // Delete modal
        const deleteModal = document.getElementById('deleteModal');
        if (deleteModal) {
            deleteModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const fileId = button.getAttribute('data-file-id');
                const fileName = button.getAttribute('data-file-name');
                
                const deleteForm = document.getElementById('deleteForm');
                const deleteFileName = document.getElementById('deleteFileName');
                
                deleteForm.action = `{{ url_for('property.property_file_delete', file_id='') }}${fileId}`;
                deleteFileName.textContent = fileName;
            });
        }
        
        // Category filter
        const categoryFilters = document.querySelectorAll('input[name="category-filter"]');
        const fileItems = document.querySelectorAll('.file-item');
        const noFilesContainer = document.getElementById('no-files-container');
        const noFilterResults = document.getElementById('no-filter-results');
        const fileCount = document.getElementById('file-count');
        
        categoryFilters.forEach(filter => {
            filter.addEventListener('change', function() {
                const category = this.value;
                let visibleCount = 0;
                
                fileItems.forEach(item => {
                    if (category === 'all' || item.dataset.category === category) {
                        item.classList.remove('d-none');
                        visibleCount++;
                    } else {
                        item.classList.add('d-none');
                    }
                });
                
                // Update file count
                fileCount.textContent = visibleCount;
                
                // Show/hide no results message
                if (visibleCount === 0 && category !== 'all') {
                    if (noFilesContainer) noFilesContainer.classList.add('d-none');
                    if (noFilterResults) noFilterResults.classList.remove('d-none');
                } else {
                    if (noFilesContainer) noFilesContainer.classList.remove('d-none');
                    if (noFilterResults) noFilterResults.classList.add('d-none');
                }
            });
        });
    });
</script>
{% endblock %}