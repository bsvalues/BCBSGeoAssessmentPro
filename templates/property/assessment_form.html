{% extends "layout.html" %}

{% block title %}{% if assessment.id %}Edit{% else %}New{% endif %} Assessment - GeoAssessmentPro{% endblock %}

{% block additionalcss %}
<style>
    .form-section {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 20px;
        color: #495057;
    }
    
    .form-label {
        font-weight: 500;
    }
    
    .required-field::after {
        content: "*";
        color: #dc3545;
        margin-left: 4px;
    }
    
    .form-text {
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('property.property_list') }}">Properties</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('property.property_detail', property_id=property.id) }}">{{ property.parcel_id }}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('property.property_assessments', property_id=property.id) }}">Assessments</a></li>
            <li class="breadcrumb-item active" aria-current="page">
                {% if assessment.id %}Edit Assessment{% else %}New Assessment{% endif %}
            </li>
        </ol>
    </nav>
    
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5">
                <i class="fas {% if assessment.id %}fa-edit{% else %}fa-plus-circle{% endif %} me-2"></i>
                {% if assessment.id %}Edit{% else %}Create{% endif %} Assessment
            </h1>
            <p class="lead text-muted">
                {% if assessment.id %}
                Update assessment information for Tax Year: {{ assessment.tax_year }}
                {% else %}
                Add a new assessment for {{ property.parcel_id }}
                {% endif %}
            </p>
        </div>
    </div>
    
    <!-- Property Summary -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h2 class="h5 mb-0">
                <i class="fas fa-building me-2"></i> Property Information
            </h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1"><strong>Parcel ID:</strong> {{ property.parcel_id }}</p>
                    <p class="mb-1"><strong>Address:</strong> {{ property.address }}, {{ property.city }}, {{ property.state }} {{ property.zip_code }}</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>Property Class:</strong> {{ property.property_class|title or 'N/A' }}</p>
                    <p class="mb-1"><strong>Status:</strong> {{ property.status|title or 'Active' }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Assessment Form -->
    <form method="post" id="assessment-form">
        {% if assessment.id %}
        <input type="hidden" name="id" value="{{ assessment.id }}">
        {% endif %}
        <input type="hidden" name="property_id" value="{{ property.id }}">
        
        <!-- Basic Information Section -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-info-circle me-2"></i> Assessment Information
            </h2>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="tax_year" class="form-label required-field">Tax Year</label>
                    <input type="number" class="form-control" id="tax_year" name="tax_year" 
                           value="{{ assessment.tax_year or current_year }}" required min="1900" max="2100">
                </div>
                
                <div class="col-md-4">
                    <label for="assessment_date" class="form-label required-field">Assessment Date</label>
                    <input type="date" class="form-control" id="assessment_date" name="assessment_date" 
                           value="{{ assessment.assessment_date or today_date }}" required>
                </div>
                
                <div class="col-md-4">
                    <label for="assessment_type" class="form-label">Assessment Type</label>
                    <select class="form-select" id="assessment_type" name="assessment_type">
                        <option value="standard" {% if assessment.assessment_type == 'standard' or not assessment.assessment_type %}selected{% endif %}>Standard</option>
                        <option value="annual" {% if assessment.assessment_type == 'annual' %}selected{% endif %}>Annual</option>
                        <option value="special" {% if assessment.assessment_type == 'special' %}selected{% endif %}>Special</option>
                        <option value="correction" {% if assessment.assessment_type == 'correction' %}selected{% endif %}>Correction</option>
                        <option value="appeal" {% if assessment.assessment_type == 'appeal' %}selected{% endif %}>Appeal</option>
                    </select>
                </div>
                
                <div class="col-md-4">
                    <label for="assessment_status" class="form-label">Assessment Status</label>
                    <select class="form-select" id="assessment_status" name="assessment_status">
                        <option value="pending" {% if assessment.assessment_status == 'pending' or not assessment.assessment_status %}selected{% endif %}>Pending</option>
                        <option value="in_progress" {% if assessment.assessment_status == 'in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="under_review" {% if assessment.assessment_status == 'under_review' %}selected{% endif %}>Under Review</option>
                        <option value="completed" {% if assessment.assessment_status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="appealed" {% if assessment.assessment_status == 'appealed' %}selected{% endif %}>Appealed</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Valuation Section -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-dollar-sign me-2"></i> Valuation
            </h2>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="land_value" class="form-label">Land Value ($)</label>
                    <input type="number" step="0.01" class="form-control" id="land_value" name="land_value" 
                           value="{{ assessment.land_value or property.land_value or '' }}">
                    <div class="form-text">Value of the land only</div>
                </div>
                
                <div class="col-md-6">
                    <label for="improvement_value" class="form-label">Improvement Value ($)</label>
                    <input type="number" step="0.01" class="form-control" id="improvement_value" name="improvement_value" 
                           value="{{ assessment.improvement_value or property.improvement_value or '' }}">
                    <div class="form-text">Value of buildings and other improvements</div>
                </div>
                
                <div class="col-md-4">
                    <label for="total_value" class="form-label">Total Value ($)</label>
                    <input type="number" step="0.01" class="form-control" id="total_value" name="total_value" 
                           value="{{ assessment.total_value or property.total_value or '' }}" readonly>
                    <div class="form-text">Land Value + Improvement Value</div>
                </div>
                
                <div class="col-md-4">
                    <label for="exemption_value" class="form-label">Exemption Value ($)</label>
                    <input type="number" step="0.01" class="form-control" id="exemption_value" name="exemption_value" 
                           value="{{ assessment.exemption_value or '0.00' }}">
                    <div class="form-text">Value exempt from taxation</div>
                </div>
                
                <div class="col-md-4">
                    <label for="taxable_value" class="form-label">Taxable Value ($)</label>
                    <input type="number" step="0.01" class="form-control" id="taxable_value" name="taxable_value" 
                           value="{{ assessment.taxable_value or '' }}" readonly>
                    <div class="form-text">Total Value - Exemption Value</div>
                </div>
            </div>
        </div>
        
        <!-- Notes Section -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-sticky-note me-2"></i> Notes
            </h2>
            <div class="row g-3">
                <div class="col-12">
                    <label for="notes" class="form-label">Assessment Notes</label>
                    <textarea class="form-control" id="notes" name="notes" rows="4">{{ assessment.notes or '' }}</textarea>
                    <div class="form-text">Additional information, justification, or comments about this assessment</div>
                </div>
            </div>
        </div>
        
        <!-- Form Actions -->
        <div class="d-flex justify-content-between mb-5">
            <a href="{{ url_for('property.property_assessments', property_id=property.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Cancel
            </a>
            
            <div>
                <button type="reset" class="btn btn-outline-warning me-2">
                    <i class="fas fa-undo me-1"></i> Reset
                </button>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas {% if assessment.id %}fa-save{% else %}fa-plus-circle{% endif %} me-1"></i>
                    {% if assessment.id %}Update{% else %}Create{% endif %} Assessment
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Calculate totals when values change
        const landValueInput = document.getElementById('land_value');
        const improvementValueInput = document.getElementById('improvement_value');
        const totalValueInput = document.getElementById('total_value');
        const exemptionValueInput = document.getElementById('exemption_value');
        const taxableValueInput = document.getElementById('taxable_value');
        
        function calculateValues() {
            const landValue = parseFloat(landValueInput.value) || 0;
            const improvementValue = parseFloat(improvementValueInput.value) || 0;
            const totalValue = landValue + improvementValue;
            const exemptionValue = parseFloat(exemptionValueInput.value) || 0;
            const taxableValue = Math.max(0, totalValue - exemptionValue);
            
            totalValueInput.value = totalValue.toFixed(2);
            taxableValueInput.value = taxableValue.toFixed(2);
        }
        
        landValueInput.addEventListener('input', calculateValues);
        improvementValueInput.addEventListener('input', calculateValues);
        exemptionValueInput.addEventListener('input', calculateValues);
        
        // Initial calculation
        calculateValues();
        
        // Form validation
        const form = document.getElementById('assessment-form');
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            form.classList.add('was-validated');
        });
    });
</script>
{% endblock %}