{% extends "layout.html" %}

{% block title %}Property Details - {{ property.parcel_id }} - GeoAssessmentPro{% endblock %}

{% block additionalcss %}
<style>
    .property-header {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .property-card {
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .property-card .card-header {
        background-color: #f8f9fa;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        font-weight: 600;
    }
    
    .map-container {
        height: 400px;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .detail-row {
        display: flex;
        margin-bottom: 10px;
    }
    
    .detail-label {
        flex: 0 0 180px;
        font-weight: 600;
        color: #6c757d;
    }
    
    .detail-value {
        flex: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('property.property_list') }}">Properties</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ property.parcel_id }}</li>
        </ol>
    </nav>
    
    <!-- Property Header -->
    <div class="property-header">
        <div class="row">
            <div class="col-md-8">
                <h1 class="h2">
                    <i class="fas fa-building me-2"></i> Property Details
                </h1>
                <h2 class="h4 text-muted">
                    Parcel ID: {{ property.parcel_id }}
                    {% if property.account_number %}
                    <span class="ms-3 small text-muted">Account #: {{ property.account_number }}</span>
                    {% endif %}
                </h2>
                <p class="lead">
                    {{ property.address }}, {{ property.city }}, {{ property.state }} {{ property.zip_code }}
                </p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <div class="mb-2">
                    <span class="badge {% if property.status == 'active' %}bg-success{% elif property.status == 'inactive' %}bg-danger{% else %}bg-warning text-dark{% endif %} p-2">
                        <i class="fas {% if property.status == 'active' %}fa-check-circle{% elif property.status == 'inactive' %}fa-times-circle{% else %}fa-exclamation-circle{% endif %} me-1"></i>
                        {{ property.status|title }}
                    </span>
                    
                    <span class="badge bg-primary ms-2 p-2">
                        <i class="fas fa-tag me-1"></i>
                        {{ property.property_class|title }}
                    </span>
                </div>
                <div class="btn-group">
                    {% if has_permission('property.edit') %}
                    <a href="{{ url_for('property.property_edit', property_id=property.id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-edit me-1"></i> Edit
                    </a>
                    {% endif %}
                    
                    <a href="{{ url_for('property.property_assessments', property_id=property.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-chart-line me-1"></i> Assessments
                    </a>
                    
                    <a href="{{ url_for('property.property_files', property_id=property.id) }}" class="btn btn-outline-info">
                        <i class="fas fa-file me-1"></i> Files
                    </a>
                    
                    {% if has_permission('property.delete') %}
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deletePropertyModal">
                        <i class="fas fa-trash-alt me-1"></i> Delete
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Content Area -->
    <div class="row">
        <!-- Main Property Details -->
        <div class="col-lg-8">
            <!-- Property General Information -->
            <div class="card property-card mb-4">
                <div class="card-header">
                    <i class="fas fa-info-circle me-2"></i> General Information
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-row">
                                <div class="detail-label">Parcel ID</div>
                                <div class="detail-value">{{ property.parcel_id }}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Account Number</div>
                                <div class="detail-value">{{ property.account_number or 'N/A' }}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Property Class</div>
                                <div class="detail-value">{{ property.property_class|title or 'N/A' }}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Zoning</div>
                                <div class="detail-value">{{ property.zoning or 'N/A' }}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Status</div>
                                <div class="detail-value">{{ property.status|title or 'Active' }}</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="detail-row">
                                <div class="detail-label">Land Area</div>
                                <div class="detail-value">{{ property.land_area|commaformat(2) or 'N/A' }} sq ft</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Lot Size</div>
                                <div class="detail-value">{{ property.lot_size|commaformat(2) or 'N/A' }} acres</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Year Built</div>
                                <div class="detail-value">{{ property.year_built or 'N/A' }}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Last Updated</div>
                                <div class="detail-value">{{ property.updated_at|dateformat }}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Created At</div>
                                <div class="detail-value">{{ property.created_at|dateformat }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Legal Description -->
            <div class="card property-card mb-4">
                <div class="card-header">
                    <i class="fas fa-gavel me-2"></i> Legal Information
                </div>
                <div class="card-body">
                    <div class="detail-row">
                        <div class="detail-label">Legal Description</div>
                        <div class="detail-value">{{ property.legal_description or 'No legal description available' }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Property Characteristics -->
            <div class="card property-card mb-4">
                <div class="card-header">
                    <i class="fas fa-home me-2"></i> Property Characteristics
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-row">
                                <div class="detail-label">Living Area</div>
                                <div class="detail-value">{{ property.living_area|commaformat(0) or 'N/A' }} sq ft</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Bedrooms</div>
                                <div class="detail-value">{{ property.bedrooms or 'N/A' }}</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="detail-row">
                                <div class="detail-label">Bathrooms</div>
                                <div class="detail-value">{{ property.bathrooms or 'N/A' }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Owner Information -->
            <div class="card property-card mb-4">
                <div class="card-header">
                    <i class="fas fa-user me-2"></i> Owner Information
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-row">
                                <div class="detail-label">Owner Name</div>
                                <div class="detail-value">{{ property.owner_name or 'N/A' }}</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="detail-row">
                                <div class="detail-label">Owner Address</div>
                                <div class="detail-value">
                                    {{ property.owner_address or 'N/A' }}
                                    {% if property.owner_city or property.owner_state or property.owner_zip %}
                                        <br>
                                        {{ [property.owner_city, property.owner_state, property.owner_zip]|reject('none')|join(', ') }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sales History -->
            <div class="card property-card mb-4">
                <div class="card-header">
                    <i class="fas fa-history me-2"></i> Last Sale Information
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-row">
                                <div class="detail-label">Last Sale Date</div>
                                <div class="detail-value">{{ property.last_sale_date|dateformat or 'N/A' }}</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="detail-row">
                                <div class="detail-label">Last Sale Price</div>
                                <div class="detail-value">{{ property.last_sale_price|format_currency or 'N/A' }}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Sale Document</div>
                                <div class="detail-value">{{ property.last_sale_document or 'N/A' }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar Content -->
        <div class="col-lg-4">
            <!-- Property Value Card -->
            <div class="card property-card mb-4">
                <div class="card-header">
                    <i class="fas fa-dollar-sign me-2"></i> Property Valuation
                </div>
                <div class="card-body text-center">
                    <div class="mb-4">
                        <h3 class="display-6 text-primary">{{ property.total_value|format_currency or '$0' }}</h3>
                        <p class="text-muted">Total Value</p>
                    </div>
                    
                    <div class="row">
                        <div class="col-6 border-end">
                            <h5>{{ property.land_value|format_currency or '$0' }}</h5>
                            <p class="text-muted small">Land Value</p>
                        </div>
                        <div class="col-6">
                            <h5>{{ property.improvement_value|format_currency or '$0' }}</h5>
                            <p class="text-muted small">Improvement Value</p>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <a href="{{ url_for('property.property_assessments', property_id=property.id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-chart-line me-1"></i> View Assessment History
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Location Card -->
            <div class="card property-card mb-4">
                <div class="card-header">
                    <i class="fas fa-map-marker-alt me-2"></i> Location
                </div>
                <div class="card-body">
                    <div class="detail-row">
                        <div class="detail-label">Address</div>
                        <div class="detail-value">{{ property.address or 'N/A' }}</div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-label">City</div>
                        <div class="detail-value">{{ property.city or 'N/A' }}</div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-label">State</div>
                        <div class="detail-value">{{ property.state or 'N/A' }}</div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-label">ZIP Code</div>
                        <div class="detail-value">{{ property.zip_code or 'N/A' }}</div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-label">Coordinates</div>
                        <div class="detail-value">
                            {% if property.latitude and property.longitude %}
                                {{ property.latitude }}, {{ property.longitude }}
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Map Card -->
            {% if property.latitude and property.longitude %}
            <div class="card property-card mb-4">
                <div class="card-header">
                    <i class="fas fa-map me-2"></i> Map
                </div>
                <div class="card-body p-0">
                    <div id="property-map" class="map-container"></div>
                </div>
            </div>
            {% endif %}
            
            <!-- Quick Links -->
            <div class="card property-card mb-4">
                <div class="card-header">
                    <i class="fas fa-link me-2"></i> Quick Links
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="{{ url_for('property.property_assessments', property_id=property.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-chart-line me-2 text-primary"></i> Assessments
                            </div>
                            <span class="badge bg-primary rounded-pill">View</span>
                        </a>
                        <a href="{{ url_for('property.property_files', property_id=property.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-file me-2 text-info"></i> Files & Documents
                            </div>
                            <span class="badge bg-info rounded-pill">View</span>
                        </a>
                        {% if has_permission('property.edit') %}
                        <a href="{{ url_for('property.property_edit', property_id=property.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-edit me-2 text-warning"></i> Edit Property
                            </div>
                            <span class="badge bg-warning text-dark rounded-pill">Edit</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Property Modal -->
{% if has_permission('property.delete') %}
<div class="modal fade" id="deletePropertyModal" tabindex="-1" aria-labelledby="deletePropertyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deletePropertyModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i> Delete Property
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this property?</p>
                <p><strong>Parcel ID:</strong> {{ property.parcel_id }}</p>
                <p><strong>Address:</strong> {{ property.address }}, {{ property.city }}, {{ property.state }} {{ property.zip_code }}</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-circle me-2"></i> This action cannot be undone. All assessments, files, and other data associated with this property will be permanently deleted.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <form method="post" action="{{ url_for('property.property_delete', property_id=property.id) }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-1"></i> Delete Property
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if property.latitude and property.longitude %}
<!-- Leaflet JS for map -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize map
        const map = L.map('property-map').setView([{{ property.latitude }}, {{ property.longitude }}], 15);
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Add marker for property location
        const marker = L.marker([{{ property.latitude }}, {{ property.longitude }}]).addTo(map);
        
        // Add popup with property info
        const popupContent = `
            <strong>{{ property.parcel_id }}</strong><br>
            {{ property.address }}<br>
            {{ property.city }}, {{ property.state }} {{ property.zip_code }}
        `;
        marker.bindPopup(popupContent).openPopup();
    });
</script>
{% endif %}
{% endblock %}