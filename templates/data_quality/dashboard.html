{% extends "layout.html" %}

{% block title %}Data Quality Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                Data Quality Dashboard
                <a href="{{ url_for('data_quality.list_alerts') }}" class="btn btn-outline-primary float-end">
                    <i class="bi bi-bell me-1"></i> Manage Alerts
                </a>
            </h1>
            
            <!-- Overview Cards -->
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card h-100 bg-primary text-white">
                        <div class="card-body">
                            <h5 class="card-title">Overall Quality Score</h5>
                            <h2 class="display-4">{{ overall_score|default('N/A', true) }}</h2>
                            <p class="card-text">Based on latest quality report</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card h-100 bg-danger text-white">
                        <div class="card-body">
                            <h5 class="card-title">Open Issues</h5>
                            <h2 class="display-4">{{ open_issues|default('0', true) }}</h2>
                            <p class="card-text">Data quality issues requiring attention</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card h-100 bg-warning text-dark">
                        <div class="card-body">
                            <h5 class="card-title">Detected Anomalies</h5>
                            <h2 class="display-4">{{ anomalies|default('0', true) }}</h2>
                            <p class="card-text">Unusual data patterns detected</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card h-100 bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title">Active Rules</h5>
                            <h2 class="display-4">{{ active_rules|default('0', true) }}</h2>
                            <p class="card-text">Data quality validation rules</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tabs for different sections -->
            <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="issues-tab" data-bs-toggle="tab" data-bs-target="#issues" type="button" role="tab" aria-controls="issues" aria-selected="true">Quality Issues</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="anomalies-tab" data-bs-toggle="tab" data-bs-target="#anomalies" type="button" role="tab" aria-controls="anomalies" aria-selected="false">Anomalies</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules" type="button" role="tab" aria-controls="rules" aria-selected="false">Validation Rules</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">Reports</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button" role="tab" aria-controls="trends" aria-selected="false">Trends</button>
                </li>
            </ul>
            
            <div class="tab-content" id="myTabContent">
                <!-- Quality Issues Tab -->
                <div class="tab-pane fade show active" id="issues" role="tabpanel" aria-labelledby="issues-tab">
                    <div class="d-flex justify-content-between mb-3">
                        <h3>Data Quality Issues</h3>
                        <div>
                            <button class="btn btn-outline-primary me-2" id="refreshIssues">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="issueFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    Filter
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="issueFilterDropdown">
                                    <li><a class="dropdown-item" href="#" data-filter="all">All Issues</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="critical">Critical Only</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="open">Open Issues</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="resolved">Resolved Issues</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Table</th>
                                    <th>Field</th>
                                    <th>Record ID</th>
                                    <th>Issue Type</th>
                                    <th>Severity</th>
                                    <th>Status</th>
                                    <th>Detected</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if issues %}
                                    {% for issue in issues %}
                                    <tr class="severity-{{ issue.severity }}">
                                        <td>{{ issue.id }}</td>
                                        <td>{{ issue.table_name }}</td>
                                        <td>{{ issue.field_name or 'N/A' }}</td>
                                        <td>{{ issue.record_id or 'N/A' }}</td>
                                        <td>{{ issue.issue_type }}</td>
                                        <td>
                                            <span class="badge {% if issue.severity == 'critical' %}bg-danger{% elif issue.severity == 'error' %}bg-warning{% elif issue.severity == 'warning' %}bg-secondary{% else %}bg-info{% endif %}">
                                                {{ issue.severity }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {% if issue.status == 'open' %}bg-danger{% elif issue.status == 'resolved' %}bg-success{% else %}bg-secondary{% endif %}">
                                                {{ issue.status }}
                                            </span>
                                        </td>
                                        <td>{{ issue.detected_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info view-issue" data-id="{{ issue.id }}">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            {% if issue.status == 'open' %}
                                            <button class="btn btn-sm btn-outline-success resolve-issue" data-id="{{ issue.id }}">
                                                <i class="bi bi-check-circle"></i>
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="9" class="text-center">No data quality issues found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Anomalies Tab -->
                <div class="tab-pane fade" id="anomalies" role="tabpanel" aria-labelledby="anomalies-tab">
                    <div class="d-flex justify-content-between mb-3">
                        <h3>Data Anomalies</h3>
                        <div>
                            <button class="btn btn-outline-primary me-2" id="refreshAnomalies">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="anomalyFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    Filter
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="anomalyFilterDropdown">
                                    <li><a class="dropdown-item" href="#" data-filter="all">All Anomalies</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="value_change">Value Changes</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="outlier">Outliers</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="open">Open Anomalies</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Table</th>
                                    <th>Field</th>
                                    <th>Record ID</th>
                                    <th>Anomaly Type</th>
                                    <th>Current Value</th>
                                    <th>Previous Value</th>
                                    <th>Severity</th>
                                    <th>Status</th>
                                    <th>Detected</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if anomaly_list %}
                                    {% for anomaly in anomaly_list %}
                                    <tr class="severity-{{ anomaly.severity }}">
                                        <td>{{ anomaly.id }}</td>
                                        <td>{{ anomaly.table_name }}</td>
                                        <td>{{ anomaly.field_name or 'N/A' }}</td>
                                        <td>{{ anomaly.record_id or 'N/A' }}</td>
                                        <td>{{ anomaly.anomaly_type }}</td>
                                        <td>{{ anomaly.current_value }}</td>
                                        <td>{{ anomaly.previous_value }}</td>
                                        <td>
                                            <span class="badge {% if anomaly.severity == 'critical' %}bg-danger{% elif anomaly.severity == 'error' %}bg-warning{% elif anomaly.severity == 'warning' %}bg-secondary{% else %}bg-info{% endif %}">
                                                {{ anomaly.severity }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {% if anomaly.status == 'open' %}bg-danger{% elif anomaly.status == 'resolved' %}bg-success{% else %}bg-secondary{% endif %}">
                                                {{ anomaly.status }}
                                            </span>
                                        </td>
                                        <td>{{ anomaly.detected_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info view-anomaly" data-id="{{ anomaly.id }}">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            {% if anomaly.status == 'open' %}
                                            <button class="btn btn-sm btn-outline-success resolve-anomaly" data-id="{{ anomaly.id }}">
                                                <i class="bi bi-check-circle"></i>
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="11" class="text-center">No data anomalies found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Validation Rules Tab -->
                <div class="tab-pane fade" id="rules" role="tabpanel" aria-labelledby="rules-tab">
                    <div class="d-flex justify-content-between mb-3">
                        <h3>Data Quality Rules</h3>
                        <div>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRuleModal">
                                <i class="bi bi-plus-circle"></i> Add Rule
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Table</th>
                                    <th>Field</th>
                                    <th>Rule Type</th>
                                    <th>Description</th>
                                    <th>Severity</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if rules %}
                                    {% for rule in rules %}
                                    <tr>
                                        <td>{{ rule.id }}</td>
                                        <td>{{ rule.table_name }}</td>
                                        <td>{{ rule.field_name or 'All Fields' }}</td>
                                        <td>{{ rule.rule_type }}</td>
                                        <td>{{ rule.description }}</td>
                                        <td>
                                            <span class="badge {% if rule.severity == 'critical' %}bg-danger{% elif rule.severity == 'error' %}bg-warning{% elif rule.severity == 'warning' %}bg-secondary{% else %}bg-info{% endif %}">
                                                {{ rule.severity }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input toggle-rule-status" type="checkbox" id="ruleStatus{{ rule.id }}" data-id="{{ rule.id }}" {% if rule.is_active %}checked{% endif %}>
                                                <label class="form-check-label" for="ruleStatus{{ rule.id }}">
                                                    {{ 'Active' if rule.is_active else 'Inactive' }}
                                                </label>
                                            </div>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary edit-rule" data-id="{{ rule.id }}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-rule" data-id="{{ rule.id }}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center">No data quality rules defined</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Reports Tab -->
                <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                    <div class="d-flex justify-content-between mb-3">
                        <h3>Data Quality Reports</h3>
                        <div>
                            <button class="btn btn-primary" id="generateReport">
                                <i class="bi bi-file-earmark-bar-graph"></i> Generate New Report
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Report Name</th>
                                    <th>Tables Checked</th>
                                    <th>Overall Score</th>
                                    <th>Critical Issues</th>
                                    <th>High Issues</th>
                                    <th>Generated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if reports %}
                                    {% for report in reports %}
                                    <tr>
                                        <td>{{ report.id }}</td>
                                        <td>{{ report.report_name }}</td>
                                        <td>{{ report.tables_checked|length }}</td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar 
                                                    {% if report.overall_score >= 90 %}bg-success
                                                    {% elif report.overall_score >= 70 %}bg-info
                                                    {% elif report.overall_score >= 50 %}bg-warning
                                                    {% else %}bg-danger{% endif %}" 
                                                    role="progressbar" style="width: {{ report.overall_score }}%;"
                                                    aria-valuenow="{{ report.overall_score }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ report.overall_score }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ report.critical_issues }}</td>
                                        <td>{{ report.high_issues }}</td>
                                        <td>{{ report.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info view-report" data-id="{{ report.id }}">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary download-report" data-id="{{ report.id }}">
                                                <i class="bi bi-download"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center">No reports available</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Trends Tab -->
                <div class="tab-pane fade" id="trends" role="tabpanel" aria-labelledby="trends-tab">
                    <div class="d-flex justify-content-between mb-3">
                        <h3>Quality Trends Analysis</h3>
                        <div>
                            <button class="btn btn-primary" id="refreshTrendsBtn">
                                <i class="bi bi-arrow-repeat"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter Controls -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="timeRangeFilter">Time Range</label>
                                        <select class="form-select" id="timeRangeFilter">
                                            <option value="7">Last 7 Days</option>
                                            <option value="30" selected>Last 30 Days</option>
                                            <option value="90">Last 90 Days</option>
                                            <option value="365">Last Year</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="metricFilter">Metrics</label>
                                        <select class="form-select" id="metricFilter">
                                            <option value="quality_score" selected>Quality Score</option>
                                            <option value="issue_count">Issue Count</option>
                                            <option value="anomaly_count">Anomaly Count</option>
                                            <option value="validation_success_rate">Validation Success Rate</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="tableFilter">Table/Dataset</label>
                                        <select class="form-select" id="tableFilter">
                                            <option value="all" selected>All Tables</option>
                                            <option value="parcel">Parcel</option>
                                            <option value="property">Property</option>
                                            <option value="assessment">Assessment</option>
                                            <option value="owner">Owner</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-success w-100" id="applyFiltersBtn">
                                        <i class="bi bi-funnel"></i> Apply Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trend Charts -->
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Historical Trend Analysis</h5>
                                </div>
                                <div class="card-body">
                                    <div id="mainTrendChart" style="height: 350px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0">Issue Type Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <div id="issueTypeChart" style="height: 250px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0">Table Quality Comparison</h5>
                                </div>
                                <div class="card-body">
                                    <div id="tableComparisonChart" style="height: 250px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Metrics Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card h-100 bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Avg. Quality Score</h5>
                                    <h2 class="display-5" id="avgQualityScore">--</h2>
                                    <p class="card-text" id="qualityScoreTrend">
                                        <span class="badge bg-success">↑ 2.3%</span> from previous period
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card h-100 bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Data Completeness</h5>
                                    <h2 class="display-5" id="dataCompleteness">--</h2>
                                    <p class="card-text" id="completenessTrend">
                                        <span class="badge bg-success">↑ 1.7%</span> from previous period
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card h-100 bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Data Accuracy</h5>
                                    <h2 class="display-5" id="dataAccuracy">--</h2>
                                    <p class="card-text" id="accuracyTrend">
                                        <span class="badge bg-warning">↓ 0.5%</span> from previous period
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card h-100 bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Data Consistency</h5>
                                    <h2 class="display-5" id="dataConsistency">--</h2>
                                    <p class="card-text" id="consistencyTrend">
                                        <span class="badge bg-success">↑ 3.1%</span> from previous period
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Rule Modal -->
<div class="modal fade" id="addRuleModal" tabindex="-1" aria-labelledby="addRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRuleModalLabel">Add Data Quality Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ruleForm">
                    <input type="hidden" id="ruleId" name="id" value="">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="tableName" class="form-label">Table Name</label>
                            <select class="form-select" id="tableName" name="table_name" required>
                                <option value="">Select Table</option>
                                {% for table in database_tables %}
                                <option value="{{ table }}">{{ table }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="fieldName" class="form-label">Field Name</label>
                            <select class="form-select" id="fieldName" name="field_name">
                                <option value="">All Fields</option>
                                <!-- Field options will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="ruleType" class="form-label">Rule Type</label>
                            <select class="form-select" id="ruleType" name="rule_type" required>
                                <option value="">Select Rule Type</option>
                                <option value="required">Required Field</option>
                                <option value="format">Format Validation</option>
                                <option value="range">Value Range</option>
                                <option value="referential">Referential Integrity</option>
                                <option value="unique">Uniqueness</option>
                                <option value="custom">Custom Validation</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="severity" class="form-label">Severity</label>
                            <select class="form-select" id="severity" name="severity" required>
                                <option value="info">Info</option>
                                <option value="warning" selected>Warning</option>
                                <option value="error">Error</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="description" name="description">
                    </div>
                    
                    <!-- Rule Type Specific Fields -->
                    <div id="formatRuleFields" class="rule-type-fields d-none">
                        <div class="mb-3">
                            <label for="formatPattern" class="form-label">Regex Pattern</label>
                            <input type="text" class="form-control" id="formatPattern" name="format_pattern">
                            <div class="form-text">Regular expression pattern for field validation</div>
                        </div>
                    </div>
                    
                    <div id="rangeRuleFields" class="rule-type-fields d-none">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="minValue" class="form-label">Minimum Value</label>
                                <input type="text" class="form-control" id="minValue" name="min_value">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="maxValue" class="form-label">Maximum Value</label>
                                <input type="text" class="form-control" id="maxValue" name="max_value">
                            </div>
                        </div>
                    </div>
                    
                    <div id="referentialRuleFields" class="rule-type-fields d-none">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="referencedTable" class="form-label">Referenced Table</label>
                                <select class="form-select" id="referencedTable" name="referenced_table">
                                    <option value="">Select Table</option>
                                    {% for table in database_tables %}
                                    <option value="{{ table }}">{{ table }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="referencedField" class="form-label">Referenced Field</label>
                                <select class="form-select" id="referencedField" name="referenced_field">
                                    <option value="">Select Field</option>
                                    <!-- Field options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isActive" name="is_active" checked>
                        <label class="form-check-label" for="isActive">Rule Active</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveRule">Save Rule</button>
            </div>
        </div>
    </div>
</div>

<!-- View Issue Modal -->
<div class="modal fade" id="viewIssueModal" tabindex="-1" aria-labelledby="viewIssueModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewIssueModalLabel">Data Quality Issue Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="issueDetails">
                <!-- Issue details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="resolveIssueBtn">Mark as Resolved</button>
            </div>
        </div>
    </div>
</div>

<!-- View Report Modal -->
<div class="modal fade" id="viewReportModal" tabindex="-1" aria-labelledby="viewReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewReportModalLabel">Data Quality Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="reportDetails">
                <!-- Report details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadReportBtn">Download Report</button>
            </div>
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div class="modal fade" id="generateReportModal" tabindex="-1" aria-labelledby="generateReportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateReportModalLabel">Generate Data Quality Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="mb-3">
                        <label for="reportName" class="form-label">Report Name</label>
                        <input type="text" class="form-control" id="reportName" name="report_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Tables to Include</label>
                        <div class="table-selection">
                            {% for table in database_tables %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="{{ table }}" id="table{{ loop.index }}" name="tables">
                                <label class="form-check-label" for="table{{ loop.index }}">
                                    {{ table }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="startReportGeneration">Generate</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include Chart.js for visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    // Initialize the data quality dashboard
    $(document).ready(function() {
        // Rule type change handler
        $('#ruleType').change(function() {
            // Hide all rule type specific fields
            $('.rule-type-fields').addClass('d-none');
            
            // Show fields for selected rule type
            const ruleType = $(this).val();
            if (ruleType === 'format') {
                $('#formatRuleFields').removeClass('d-none');
            } else if (ruleType === 'range') {
                $('#rangeRuleFields').removeClass('d-none');
            } else if (ruleType === 'referential') {
                $('#referentialRuleFields').removeClass('d-none');
            }
        });
        
        // Table selection change handler - populate field dropdown
        $('#tableName').change(function() {
            const tableName = $(this).val();
            if (tableName) {
                // Clear current options
                $('#fieldName').html('<option value="">All Fields</option>');
                
                // Fetch fields for selected table
                $.ajax({
                    url: '/api/table-fields',
                    type: 'GET',
                    data: { table_name: tableName },
                    success: function(response) {
                        if (response.success && response.fields) {
                            response.fields.forEach(function(field) {
                                $('#fieldName').append(`<option value="${field}">${field}</option>`);
                            });
                        }
                    }
                });
            }
        });
        
        // Save rule button handler
        $('#saveRule').click(function() {
            const ruleData = {
                id: $('#ruleId').val(),
                table_name: $('#tableName').val(),
                field_name: $('#fieldName').val() || null,
                rule_type: $('#ruleType').val(),
                severity: $('#severity').val(),
                description: $('#description').val(),
                is_active: $('#isActive').is(':checked'),
                rule_config: {}
            };
            
            // Add rule type specific data
            const ruleType = $('#ruleType').val();
            if (ruleType === 'format') {
                ruleData.rule_config.pattern = $('#formatPattern').val();
            } else if (ruleType === 'range') {
                ruleData.rule_config.min_value = $('#minValue').val();
                ruleData.rule_config.max_value = $('#maxValue').val();
            } else if (ruleType === 'referential') {
                ruleData.rule_config.referenced_table = $('#referencedTable').val();
                ruleData.rule_config.referenced_field = $('#referencedField').val();
            }
            
            // Send to server
            $.ajax({
                url: '/data-quality/rule',
                type: ruleData.id ? 'PUT' : 'POST',
                contentType: 'application/json',
                data: JSON.stringify(ruleData),
                success: function(response) {
                    if (response.success) {
                        $('#addRuleModal').modal('hide');
                        // Refresh rules list
                        location.reload();
                    } else {
                        alert('Error saving rule: ' + response.message);
                    }
                },
                error: function() {
                    alert('Error communicating with server');
                }
            });
        });
        
        // Generate report button handler
        $('#generateReport').click(function() {
            $('#reportName').val('Data Quality Report ' + new Date().toISOString().split('T')[0]);
            $('#generateReportModal').modal('show');
        });
        
        // View issue details
        $('.view-issue').click(function() {
            const issueId = $(this).data('id');
            
            $.ajax({
                url: `/data-quality/issue/${issueId}`,
                type: 'GET',
                success: function(response) {
                    if (response.success && response.issue) {
                        const issue = response.issue;
                        
                        // Populate modal with issue details
                        let detailsHtml = `
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Issue ID:</h6>
                                    <p>${issue.id}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Detected At:</h6>
                                    <p>${issue.detected_at}</p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Table:</h6>
                                    <p>${issue.table_name}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Field:</h6>
                                    <p>${issue.field_name || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Record ID:</h6>
                                    <p>${issue.record_id || 'N/A'}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Issue Type:</h6>
                                    <p>${issue.issue_type}</p>
                                </div>
                            </div>
                        `;
                        
                        // Add issue value if available
                        if (issue.issue_value) {
                            detailsHtml += `
                                <div class="row">
                                    <div class="col-12">
                                        <h6>Issue Value:</h6>
                                        <p>${issue.issue_value}</p>
                                    </div>
                                </div>
                            `;
                        }
                        
                        $('#issueDetails').html(detailsHtml);
                        
                        // Show modal
                        $('#viewIssueModal').modal('show');
                    } else {
                        alert('Error loading issue details');
                    }
                },
                error: function() {
                    alert('Error communicating with server');
                }
            });
        });
        
        // ==================== TREND ANALYSIS FUNCTIONALITY ====================
        
        // Chart objects
        let mainTrendChart = null;
        let issueTypeChart = null;
        let tableComparisonChart = null;
        
        // Initialize trend analysis if the tab is shown
        $('#trends-tab').on('shown.bs.tab', function (e) {
            initializeTrendCharts();
            loadTrendData();
        });
        
        // Handle refresh button click
        $('#refreshTrendsBtn').on('click', function() {
            loadTrendData();
        });
        
        // Handle apply filters button click
        $('#applyFiltersBtn').on('click', function() {
            loadTrendData();
        });
        
        // Initialize the trend charts with empty data
        function initializeTrendCharts() {
            if (!mainTrendChart) {
                const mainCtx = document.getElementById('mainTrendChart');
                if (mainCtx) {
                    mainTrendChart = new Chart(mainCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Quality Score',
                                data: [],
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Quality Score (%)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Date'
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `Score: ${context.parsed.y}%`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            if (!issueTypeChart) {
                const issueCtx = document.getElementById('issueTypeChart');
                if (issueCtx) {
                    issueTypeChart = new Chart(issueCtx, {
                        type: 'pie',
                        data: {
                            labels: ['Format', 'Required', 'Range', 'Uniqueness', 'Referential'],
                            datasets: [{
                                data: [0, 0, 0, 0, 0],
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.7)',
                                    'rgba(54, 162, 235, 0.7)',
                                    'rgba(255, 206, 86, 0.7)',
                                    'rgba(75, 192, 192, 0.7)',
                                    'rgba(153, 102, 255, 0.7)'
                                ],
                                borderColor: [
                                    'rgba(255, 99, 132, 1)',
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 206, 86, 1)',
                                    'rgba(75, 192, 192, 1)',
                                    'rgba(153, 102, 255, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.raw;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total ? ((value / total) * 100).toFixed(1) : 0;
                                            return `${context.label}: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            if (!tableComparisonChart) {
                const tableCtx = document.getElementById('tableComparisonChart');
                if (tableCtx) {
                    tableComparisonChart = new Chart(tableCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Parcel', 'Property', 'Assessment', 'Owner'],
                            datasets: [{
                                label: 'Quality Score',
                                data: [0, 0, 0, 0],
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Quality Score (%)'
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `Score: ${context.parsed.y}%`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
        }
        
        // Load trend data from the server
        function loadTrendData() {
            const timeRange = $('#timeRangeFilter').val();
            const metric = $('#metricFilter').val();
            const table = $('#tableFilter').val();
            
            // Show loading indicators
            updateLoadingState(true);
            
            // Fetch trend data from server
            $.ajax({
                url: '/data-quality/trends',
                method: 'GET',
                data: {
                    time_range: timeRange,
                    metric: metric,
                    table: table
                },
                dataType: 'json',
                success: function(data) {
                    updateCharts(data);
                    updateMetricsCards(data);
                    updateLoadingState(false);
                },
                error: function(xhr, status, error) {
                    console.error('Error loading trend data:', error);
                    // Use sample data for demo if server returns error
                    const sampleData = generateSampleTrendData();
                    updateCharts(sampleData);
                    updateMetricsCards(sampleData);
                    updateLoadingState(false);
                }
            });
        }
        
        // Update charts with data
        function updateCharts(data) {
            // Update main trend chart
            if (mainTrendChart && data.trends) {
                mainTrendChart.data.labels = data.trends.dates;
                mainTrendChart.data.datasets[0].data = data.trends.values;
                mainTrendChart.data.datasets[0].label = $('#metricFilter option:selected').text();
                mainTrendChart.update();
            }
            
            // Update issue type distribution chart
            if (issueTypeChart && data.issue_distribution) {
                issueTypeChart.data.labels = data.issue_distribution.labels;
                issueTypeChart.data.datasets[0].data = data.issue_distribution.values;
                issueTypeChart.update();
            }
            
            // Update table comparison chart
            if (tableComparisonChart && data.table_comparison) {
                tableComparisonChart.data.labels = data.table_comparison.labels;
                tableComparisonChart.data.datasets[0].data = data.table_comparison.values;
                tableComparisonChart.update();
            }
        }
        
        // Update metrics summary cards
        function updateMetricsCards(data) {
            if (data.summary) {
                // Update quality score
                $('#avgQualityScore').text(data.summary.avg_quality_score + '%');
                updateTrendBadge('#qualityScoreTrend', data.summary.quality_score_trend);
                
                // Update completeness
                $('#dataCompleteness').text(data.summary.completeness + '%');
                updateTrendBadge('#completenessTrend', data.summary.completeness_trend);
                
                // Update accuracy
                $('#dataAccuracy').text(data.summary.accuracy + '%');
                updateTrendBadge('#accuracyTrend', data.summary.accuracy_trend);
                
                // Update consistency
                $('#dataConsistency').text(data.summary.consistency + '%');
                updateTrendBadge('#consistencyTrend', data.summary.consistency_trend);
            }
        }
        
        // Update trend badge (up/down indicator)
        function updateTrendBadge(selector, trendValue) {
            const element = $(selector);
            const badge = element.find('.badge');
            
            if (trendValue > 0) {
                badge.removeClass('bg-warning bg-danger').addClass('bg-success');
                badge.html(`↑ ${Math.abs(trendValue).toFixed(1)}%`);
            } else if (trendValue < 0) {
                badge.removeClass('bg-success bg-danger').addClass('bg-warning');
                badge.html(`↓ ${Math.abs(trendValue).toFixed(1)}%`);
            } else {
                badge.removeClass('bg-success bg-warning').addClass('bg-secondary');
                badge.html(`→ 0.0%`);
            }
        }
        
        // Toggle loading state
        function updateLoadingState(isLoading) {
            if (isLoading) {
                $('#refreshTrendsBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...');
                $('#applyFiltersBtn').prop('disabled', true);
            } else {
                $('#refreshTrendsBtn').prop('disabled', false).html('<i class="bi bi-arrow-repeat"></i> Refresh Data');
                $('#applyFiltersBtn').prop('disabled', false);
            }
        }
        
        // Generate sample trend data for development/demo purposes
        function generateSampleTrendData() {
            const dates = [];
            const today = new Date();
            const values = [];
            const timeRange = parseInt($('#timeRangeFilter').val());
            
            // Generate dates and random trend values
            for (let i = timeRange; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push(date.toLocaleDateString());
                
                // Generate a realistic trend line (85-95 quality score with some variation)
                const baseValue = 90;
                const variation = 5;
                const randomFactor = Math.sin(i / 5) * variation;
                values.push(Math.round(baseValue + randomFactor));
            }
            
            return {
                trends: {
                    dates: dates,
                    values: values
                },
                issue_distribution: {
                    labels: ['Format', 'Required', 'Range', 'Uniqueness', 'Referential'],
                    values: [12, 19, 8, 5, 2]
                },
                table_comparison: {
                    labels: ['Parcel', 'Property', 'Assessment', 'Owner'],
                    values: [92, 88, 95, 91]
                },
                summary: {
                    avg_quality_score: 91,
                    quality_score_trend: 2.3,
                    completeness: 94,
                    completeness_trend: 1.7,
                    accuracy: 89,
                    accuracy_trend: -0.5,
                    consistency: 92,
                    consistency_trend: 3.1
                }
            };
        }
    });
</script>
{% endblock %}