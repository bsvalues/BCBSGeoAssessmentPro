{% extends "layout.html" %}

{% block title %}Notification System Configuration{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h1 class="mb-4">
        <i class="fas fa-bell me-2"></i>Notification System Configuration
    </h1>
    
    <!-- Environment Banner -->
    <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
        <div class="me-3">
            <i class="fas fa-code-branch fa-2x"></i>
        </div>
        <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-center">
                <strong id="environment-name">Environment: {{ environment|default('Development') }}</strong>
                <div>
                    <span class="badge bg-secondary">Version: {{ version|default('1.0.0') }}</span>
                    <span class="badge bg-dark ms-2">Build: {{ build_id|default('development') }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Channel Configuration Cards -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>Email Notifications</h5>
                </div>
                <div class="card-body">
                    <form id="emailConfigForm" action="{{ url_for('configure_email_notifications') }}" method="post">
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="email_enabled" name="email_enabled" 
                                   {% if email_config and email_config.enabled %}checked{% endif %}>
                            <label class="form-check-label" for="email_enabled">Enable Email Notifications</label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="smtp_server" class="form-label">SMTP Server</label>
                            <input type="text" class="form-control" id="smtp_server" name="smtp_server" 
                                   value="{{ email_config.smtp_server if email_config else '' }}" 
                                   placeholder="smtp.example.com">
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="smtp_port" class="form-label">SMTP Port</label>
                                <input type="number" class="form-control" id="smtp_port" name="smtp_port" 
                                       value="{{ email_config.smtp_port if email_config else '587' }}"
                                       placeholder="587">
                            </div>
                            <div class="col-md-6">
                                <label for="smtp_security" class="form-label">Security</label>
                                <select class="form-select" id="smtp_security" name="smtp_security">
                                    <option value="tls" {% if email_config and email_config.smtp_security == 'tls' %}selected{% endif %}>TLS</option>
                                    <option value="ssl" {% if email_config and email_config.smtp_security == 'ssl' %}selected{% endif %}>SSL</option>
                                    <option value="none" {% if email_config and email_config.smtp_security == 'none' %}selected{% endif %}>None</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="smtp_username" class="form-label">SMTP Username</label>
                            <input type="text" class="form-control" id="smtp_username" name="smtp_username" 
                                   value="{{ email_config.smtp_username if email_config else '' }}"
                                   placeholder="username@example.com">
                        </div>
                        
                        <div class="mb-3">
                            <label for="smtp_password" class="form-label">SMTP Password</label>
                            <input type="password" class="form-control" id="smtp_password" name="smtp_password" 
                                   placeholder="••••••••">
                            <div class="form-text">Leave blank to keep existing password.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="from_address" class="form-label">From Address</label>
                            <input type="email" class="form-control" id="from_address" name="from_address" 
                                   value="{{ email_config.from_address if email_config else '' }}"
                                   placeholder="notifications@bentoncounty.gov">
                        </div>
                        
                        <div class="mb-3">
                            <label for="default_recipients" class="form-label">Default Recipients</label>
                            <input type="text" class="form-control" id="default_recipients" name="default_recipients" 
                                   value="{{ email_config.default_recipients if email_config else '' }}"
                                   placeholder="admin@example.com, manager@example.com">
                            <div class="form-text">Separate multiple email addresses with commas.</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Save Email Configuration</button>
                        <button type="button" class="btn btn-outline-info ms-2" id="testEmail">Test Email</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-comment-dots me-2"></i>Slack Notifications</h5>
                </div>
                <div class="card-body">
                    <form id="slackConfigForm" action="{{ url_for('configure_slack_notifications') }}" method="post">
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="slack_enabled" name="slack_enabled" 
                                   {% if slack_config and slack_config.enabled %}checked{% endif %}>
                            <label class="form-check-label" for="slack_enabled">Enable Slack Notifications</label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="webhook_url" class="form-label">Webhook URL</label>
                            <input type="text" class="form-control" id="webhook_url" name="webhook_url" 
                                   value="{{ slack_config.webhook_url if slack_config else '' }}"
                                   placeholder="https://hooks.slack.com/services/...">
                        </div>
                        
                        <div class="mb-3">
                            <label for="default_channel" class="form-label">Default Channel</label>
                            <input type="text" class="form-control" id="default_channel" name="default_channel" 
                                   value="{{ slack_config.default_channel if slack_config else '#sync-notifications' }}"
                                   placeholder="#sync-notifications">
                        </div>
                        
                        <div class="mb-3">
                            <label for="username" class="form-label">Bot Username</label>
                            <input type="text" class="form-control" id="username" name="username" 
                                   value="{{ slack_config.username if slack_config else 'Sync Bot' }}"
                                   placeholder="Sync Bot">
                        </div>
                        
                        <div class="mb-3">
                            <label for="icon_emoji" class="form-label">Icon Emoji</label>
                            <input type="text" class="form-control" id="icon_emoji" name="icon_emoji" 
                                   value="{{ slack_config.icon_emoji if slack_config else ':sync:' }}"
                                   placeholder=":sync:">
                        </div>
                        
                        <button type="submit" class="btn btn-info">Save Slack Configuration</button>
                        <button type="button" class="btn btn-outline-info ms-2" id="testSlack">Test Slack</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification Routing -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-route me-2"></i>Notification Routing</h5>
                </div>
                <div class="card-body">
                    <form id="routingConfigForm" action="{{ url_for('configure_notification_routing') }}" method="post">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Severity Level</th>
                                        <th>Log</th>
                                        <th>Email</th>
                                        <th>Slack</th>
                                        <th>SMS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Info</td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_info_log" 
                                                       checked disabled>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_info_email" 
                                                       {% if routing_config and 'email' in routing_config.get('info', []) %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_info_slack" 
                                                       {% if routing_config and 'slack' in routing_config.get('info', []) %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_info_sms" 
                                                       {% if routing_config and 'sms' in routing_config.get('info', []) %}checked{% endif %}>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Warning</td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_warning_log" 
                                                       checked disabled>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_warning_email" 
                                                       {% if routing_config and 'email' in routing_config.get('warning', []) %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_warning_slack" 
                                                       {% if routing_config and 'slack' in routing_config.get('warning', []) %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_warning_sms" 
                                                       {% if routing_config and 'sms' in routing_config.get('warning', []) %}checked{% endif %}>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Error</td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_error_log" 
                                                       checked disabled>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_error_email" 
                                                       {% if routing_config and 'email' in routing_config.get('error', []) %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_error_slack" 
                                                       {% if routing_config and 'slack' in routing_config.get('error', []) %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_error_sms" 
                                                       {% if routing_config and 'sms' in routing_config.get('error', []) %}checked{% endif %}>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Critical</td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_critical_log" 
                                                       checked disabled>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_critical_email" 
                                                       {% if routing_config and 'email' in routing_config.get('critical', []) %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_critical_slack" 
                                                       {% if routing_config and 'slack' in routing_config.get('critical', []) %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="route_critical_sms" 
                                                       {% if routing_config and 'sms' in routing_config.get('critical', []) %}checked{% endif %}>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <button type="submit" class="btn btn-success">Save Routing Configuration</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification Log -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Notification History</h5>
                        <button class="btn btn-sm btn-light" id="refresh-notifications">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Job ID</th>
                                    <th>Subject</th>
                                    <th>Severity</th>
                                    <th>Channel</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="notification-log">
                                {% for log in notification_logs %}
                                <tr>
                                    <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>{{ log.job_id }}</td>
                                    <td>{{ log.subject }}</td>
                                    <td>
                                        <span class="badge bg-{{ log.get_severity_badge() }}">{{ log.severity }}</span>
                                    </td>
                                    <td>{{ log.channel }}</td>
                                    <td>
                                        {% if log.success %}
                                        <span class="badge bg-success">Sent</span>
                                        {% else %}
                                        <span class="badge bg-danger">Failed</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center">No notification logs found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Email Modal -->
<div class="modal fade" id="testEmailModal" tabindex="-1" aria-labelledby="testEmailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="testEmailModalLabel">Test Email Notification</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="testEmailForm" action="{{ url_for('test_email_notification') }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="test_email_recipient" class="form-label">Recipient Email</label>
                        <input type="email" class="form-control" id="test_email_recipient" name="recipient" 
                               placeholder="recipient@example.com" required>
                    </div>
                    <div class="mb-3">
                        <label for="test_email_subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="test_email_subject" name="subject" 
                               value="Test Notification from Data Hub" required>
                    </div>
                    <div class="mb-3">
                        <label for="test_email_message" class="form-label">Message</label>
                        <textarea class="form-control" id="test_email_message" name="message" rows="3" required>This is a test notification from the Benton County Data Hub.</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Test Email</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Test Slack Modal -->
<div class="modal fade" id="testSlackModal" tabindex="-1" aria-labelledby="testSlackModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="testSlackModalLabel">Test Slack Notification</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="testSlackForm" action="{{ url_for('test_slack_notification') }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="test_slack_channel" class="form-label">Channel</label>
                        <input type="text" class="form-control" id="test_slack_channel" name="channel" 
                               placeholder="#sync-notifications" required>
                    </div>
                    <div class="mb-3">
                        <label for="test_slack_message" class="form-label">Message</label>
                        <textarea class="form-control" id="test_slack_message" name="message" rows="3" required>This is a test notification from the Benton County Data Hub.</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">Send Test Message</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript for forms and modals -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Test Email Button
    document.getElementById('testEmail').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('testEmailModal'));
        modal.show();
    });
    
    // Test Slack Button
    document.getElementById('testSlack').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('testSlackModal'));
        modal.show();
    });
    
    // Refresh notification log
    document.getElementById('refresh-notifications').addEventListener('click', function() {
        fetch('/sync/notification_logs')
            .then(response => response.json())
            .then(data => {
                const logTable = document.getElementById('notification-log');
                
                if (data.logs.length === 0) {
                    logTable.innerHTML = '<tr><td colspan="6" class="text-center">No notification logs found</td></tr>';
                    return;
                }
                
                logTable.innerHTML = '';
                data.logs.forEach(log => {
                    const severityBadge = getSeverityBadgeClass(log.severity);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${log.created_at}</td>
                        <td>${log.job_id || '-'}</td>
                        <td>${log.subject}</td>
                        <td><span class="badge bg-${severityBadge}">${log.severity}</span></td>
                        <td>${log.channel}</td>
                        <td>
                            ${log.success 
                                ? '<span class="badge bg-success">Sent</span>' 
                                : '<span class="badge bg-danger">Failed</span>'}
                        </td>
                    `;
                    logTable.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error refreshing notification log:', error);
            });
    });
    
    // Helper function for severity badge classes
    function getSeverityBadgeClass(severity) {
        switch(severity.toLowerCase()) {
            case 'critical':
                return 'danger';
            case 'error':
                return 'warning';
            case 'warning':
                return 'warning';
            case 'info':
                return 'info';
            default:
                return 'secondary';
        }
    }
});
</script>
{% endblock %}